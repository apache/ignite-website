"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[5262],{1993:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"configure-and-operate/operations/disaster-recovery-system-groups","title":"Disaster Recovery for System Groups","description":"An Apache Ignite cluster includes two system RAFT groups, both of which are essential for the cluster\'s normal operation:","source":"@site/docs/configure-and-operate/operations/disaster-recovery-system-groups.md","sourceDirName":"configure-and-operate/operations","slug":"/configure-and-operate/operations/disaster-recovery-system-groups","permalink":"/suggested-site/docs/ignite3/3.1.0/configure-and-operate/operations/disaster-recovery-system-groups","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"disaster-recovery-system-groups","title":"Disaster Recovery for System Groups","sidebar_label":"System Groups Recovery"},"sidebar":"tutorialSidebar","previous":{"title":"Data Partitions Recovery","permalink":"/suggested-site/docs/ignite3/3.1.0/configure-and-operate/operations/disaster-recovery-partitions"},"next":{"title":"Handle Exceptions","permalink":"/suggested-site/docs/ignite3/3.1.0/configure-and-operate/operations/handle-exceptions"}}');var n=r(74848),s=r(28453);const i={id:"disaster-recovery-system-groups",title:"Disaster Recovery for System Groups",sidebar_label:"System Groups Recovery"},a=void 0,l={},c=[{value:"Cluster Management Group",id:"cluster-management-group",level:2},{value:"Metastorage Group",id:"metastorage-group",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.p,{children:"An Apache Ignite cluster includes two system RAFT groups, both of which are essential for the cluster's normal operation:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"/3.1.0/configure-and-operate/operations/lifecycle#cluster-management-group",children:"Cluster Management Group (CMG)"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"/3.1.0/configure-and-operate/operations/lifecycle#cluster-metastorage-group",children:"Metastorage Group (MG)"})}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["You perform ",(0,n.jsx)(t.em,{children:"disaster recovery"})," operations on ",(0,n.jsx)(t.em,{children:"system RAFT groups"})," to recover permanent ",(0,n.jsx)(t.em,{children:"majority loss"}),". When a system RAFT group loses majority, it becomes unavailable. When CMG is unavailable, the cluster itself remains available with limitations: it can still process most of the operations, but it cannot join new nodes, start/restart existing nodes, and start building new indexes. When MG is unavailable, the cluster becomes unusable; it cannot handle even GET/PUT/SQL requests."]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["Disaster recovery for ",(0,n.jsx)(t.a,{href:"/3.1.0/configure-and-operate/operations/disaster-recovery-partitions",children:"data partitions"})," is described in a separate page."]})}),"\n",(0,n.jsxs)(t.p,{children:["You see that the majority has been lost in cluster logs in the console or in the ",(0,n.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Log_rotation",children:"rotated log files"}),". When a RAFT group becomes unavailable, the logs would show something like ",(0,n.jsx)(t.code,{children:"Send with retry timed out [retryCount = 11, groupId = cmg_group]."})," or ",(0,n.jsx)(t.code,{children:"Send with retry timed out [retryCount = 11, groupId = metastorage_group]."}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["An indicator that CMG is down is when a node does not start after a ",(0,n.jsx)(t.code,{children:"restart"})," command. This is reflected in the log as ",(0,n.jsx)(t.code,{children:"Local CMG state recovered, starting the CMG"}),", not followed by ",(0,n.jsx)(t.code,{children:"Successfully joined the cluster"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["If a node tries to start when CMG is available, but MG is not, the log shows ",(0,n.jsx)(t.code,{children:"Metastorage info on start"})," not followed by ",(0,n.jsx)(t.code,{children:"Performing MetaStorage recovery"}),"."]}),"\n",(0,n.jsx)(t.admonition,{type:"warning",children:(0,n.jsxs)(t.p,{children:["Exercise caution when applying disaster recovery commands to system node groups. These commands might result in ",(0,n.jsx)(t.em,{children:"split brain"})," (split your cluster into two clusters). Use the recovery commands as the last resort, only if the majority for CMG/MG is lost permanently."]})}),"\n",(0,n.jsx)(t.h2,{id:"cluster-management-group",children:"Cluster Management Group"}),"\n",(0,n.jsx)(t.p,{children:"If CMG loses majority:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Restart CMG nodes to restore the lost majority."}),"\n",(0,n.jsxs)(t.li,{children:["If the above fails, forcefully assign a new majority using the following ",(0,n.jsx)(t.a,{href:"/3.1.0/tools/cli-commands",children:"CLI command"})," (manually or via REST): ",(0,n.jsx)(t.code,{children:"recovery cluster reset --url=<node-url> --cluster-management-group=<new-cmg-nodes>"}),"."]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["The command is sent to the node indicated by the ",(0,n.jsx)(t.code,{children:"--url"})," parameter, which must belong to the ",(0,n.jsx)(t.code,{children:"new-cmg-nodes"})," RAFT group. This node becomes the ",(0,n.jsx)(t.em,{children:"Repair Conductor"}),", and it initiates the ",(0,n.jsx)(t.code,{children:"reset"})," procedure."]}),"\n",(0,n.jsx)(t.p,{children:"The above procedure might fail for the following reasons:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Some of the nodes specified in ",(0,n.jsx)(t.code,{children:"new-cmg-nodes"})," are not in the physical topology."]}),"\n",(0,n.jsx)(t.li,{children:"The Repair Conductor does not have all the information it needs to start the procedure."}),"\n"]}),"\n",(0,n.jsxs)(t.ol,{start:"3",children:["\n",(0,n.jsxs)(t.li,{children:["If some nodes were down or were unavailable due to a network partition (and hence did not participate in the repair):","\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Start these nodes (or restore network connectivity and restart them)."}),"\n",(0,n.jsxs)(t.li,{children:["Migrate these nodes to the repaired cluster using the following ",(0,n.jsx)(t.a,{href:"/3.1.0/tools/cli-commands",children:"CLI command"})," (manually or via REST): ",(0,n.jsx)(t.code,{children:"recovery cluster migrate --old-cluster-url=<url-of-old-cluster-node> --new-cluster-url=<url-of-new-cluster-node>"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"metastorage-group",children:"Metastorage Group"}),"\n",(0,n.jsx)(t.p,{children:"If MG loses majority:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Restart MG nodes (or at least their RAFT nodes inside Apache Ignite nodes)."}),"\n",(0,n.jsxs)(t.li,{children:["If the above fails:","\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Make sure that every node that could be started had started and joined the cluster."}),"\n",(0,n.jsxs)(t.li,{children:["Forcefully assign a new majority using the following ",(0,n.jsx)(t.a,{href:"/3.1.0/tools/cli-commands",children:"CLI command"})," (manually or via REST): ",(0,n.jsx)(t.code,{children:"recovery cluster reset --url=<existing-node-url> [--cluster-management-group=<new-cmg-nodes>] --metastorage-replication-factor=N"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"N"})," is the requested number of the voting RAFT nodes in the MG after repair. If you omit ",(0,n.jsx)(t.code,{children:"--cluster-management-group"}),", the command takes the current CMG voting members set from the CMG leader; if CMG is not available, the command fails."]}),"\n",(0,n.jsxs)(t.p,{children:["The command is sent to the node specified by ",(0,n.jsx)(t.code,{children:"--url"}),". This node becomes the ",(0,n.jsx)(t.em,{children:"Repair Conductor"}),", and it initiates the ",(0,n.jsx)(t.code,{children:"reset"})," procedure."]}),"\n",(0,n.jsx)(t.p,{children:"If the Repair Conductor fails to repair MG, the procedure has to be repeated manually (there is no failover)."}),"\n",(0,n.jsxs)(t.ol,{start:"3",children:["\n",(0,n.jsxs)(t.li,{children:["If some nodes were down or were unavailable due to a network partition (and hence did not participate in the repair):","\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Start these nodes (or restore network connectivity and restart them)."}),"\n",(0,n.jsxs)(t.li,{children:["Migrate these nodes to the repaired cluster using the following ",(0,n.jsx)(t.a,{href:"/3.1.0/tools/cli-commands",children:"CLI command"})," (manually or via REST): ",(0,n.jsx)(t.code,{children:"recovery cluster migrate --old-cluster-url=<url-of-old-cluster-node> --new-cluster-url=<url-of-new-cluster-node>"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["If one of the nodes has a revision in its metastorage that is not present on any of the nodes that had participated in the repair, this means that its metastorage has diverged from the MG leader's metastorage. Such a node will not be allowed to join the cluster. Its startup will fail with ",(0,n.jsx)(t.code,{children:"MetastorageDivergedException (error code META-7)"}),". Remove the data from the above metastorage-divergent node and have it join the cluster as a blank node."]})})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},28453:(e,t,r)=>{r.d(t,{R:()=>i,x:()=>a});var o=r(96540);const n={},s=o.createContext(n);function i(e){const t=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),o.createElement(s.Provider,{value:t},e.children)}}}]);